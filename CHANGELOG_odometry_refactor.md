# é‡Œç¨‹è®¡èŠ‚ç‚¹é‡æ„æ—¥å¿— (2025-01-08)

## ğŸ¯ é‡å¤§æ¶æ„å˜æ›´

### æ—§æ¶æ„ï¼ˆå·²åºŸå¼ƒï¼‰
- ä¸‹ä½æœºå‘é€50msçª—å£çš„**é¢„ç§¯åˆ†ä½ç§»å¢é‡** (`disp_x`, `disp_y`, `delta_theta`)
- ä¸Šä½æœºç›´æ¥ç´¯åŠ è¿™äº›å¢é‡
- ä½¿ç”¨ä¸‹ä½æœºæ—¶é—´æˆ³è®¡ç®—dt

### æ–°æ¶æ„ï¼ˆå½“å‰ï¼‰
- ä¸‹ä½æœºå‘é€**å®æ—¶é€Ÿåº¦** (`chassis_vx`, `chassis_vy`, `chassis_w`)
- ä¸Šä½æœºä½¿ç”¨**ROSæ—¶é—´æˆ³**è®¡ç®—dtå¹¶è¿›è¡Œç§¯åˆ†
- æ›´çµæ´»ã€æ›´æ ‡å‡†çš„é‡Œç¨‹è®¡å¤„ç†æµç¨‹

## ğŸ“¦ æ•°æ®åŒ…ç»“æ„æ›´æ–°

### Vision_Send_s (50å­—èŠ‚)
```c
uint8_t header;              // 0x5A
uint8_t [ä½åŸŸ1å­—èŠ‚]          // detect_color, task_mode, flags...
float roll, pitch, yaw;      // IMUå§¿æ€ (12å­—èŠ‚)
float delta_theta;           // é—ç•™å­—æ®µï¼Œä¸å†ä½¿ç”¨
float disp_x, disp_y;        // é—ç•™å­—æ®µï¼Œä¸å†ä½¿ç”¨
float heading_diff;          // é—ç•™å­—æ®µ
float chassis_vx;            // å®æ—¶é€Ÿåº¦X (m/s, æœºå™¨äººåæ ‡ç³»)
float chassis_vy;            // å®æ—¶é€Ÿåº¦Y (m/s, æœºå™¨äººåæ ‡ç³»)
float chassis_w;             // è§’é€Ÿåº¦ (rad/s)
uint16_t game_time;          // æ¯”èµ›æ—¶é—´ (2å­—èŠ‚)
uint32_t timestamp;          // æ¿è½½æ—¶é—´æˆ³ (4å­—èŠ‚, ä¸ä½¿ç”¨)
uint16_t checksum;           // CRC16 (2å­—èŠ‚)
```

## ğŸ”§ æ ¸å¿ƒæ”¹è¿›

### 1. æ—¶é—´å¯¹é½
- âœ… ä½¿ç”¨ `rclcpp::Time` ä½œä¸ºå”¯ä¸€æ—¶é—´æº
- âœ… dtè®¡ç®—ç¨³å®šå¯é ï¼ˆé¿å…ä¸‹ä½æœºæ—¶é—´æˆ³è·³å˜ï¼‰
- âœ… dtä¿æŠ¤ï¼šæ‹’ç» < 0.1ms æˆ– > 500ms çš„å¼‚å¸¸å€¼

### 2. é€Ÿåº¦ç§¯åˆ†æµç¨‹
```cpp
vx_robot, vy_robot, wz = ä»ä¸‹ä½æœºè¯»å–å®æ—¶é€Ÿåº¦
dt = (å½“å‰ROSæ—¶é—´ - ä¸Šæ¬¡ROSæ—¶é—´).seconds()

// é€Ÿåº¦æ­»åŒºè¿‡æ»¤ï¼ˆ1mm/s, 0.001rad/sï¼‰
if |v| < threshold: v = 0

// è®¡ç®—ä½ç§»å¢é‡
dx_robot = vx_robot * dt
dy_robot = vy_robot * dt

// è½¬æ¢åˆ°ä¸–ç•Œåæ ‡ç³»
dx_world = dx_robot * cos(Î¸) - dy_robot * sin(Î¸)
dy_world = dx_robot * sin(Î¸) + dy_robot * cos(Î¸)

// ç´¯åŠ ä½å§¿
x += dx_world
y += dy_world
Î¸ += wz * dt
```

### 3. é™æ­¢åˆ¤æ–­ï¼ˆæ™ºèƒ½åŒ–ï¼‰
- ç»¼åˆè¿åŠ¨é€Ÿåº¦ = å¹³ç§»é€Ÿåº¦ + æ—‹è½¬é€Ÿåº¦Ã—ç‰¹å¾åŠå¾„
- é˜ˆå€¼ï¼š2mm/s
- é™æ­¢æ—¶ï¼šé€Ÿåº¦æŒ‡æ•°è¡°å‡ï¼ˆ0.7ç³»æ•°ï¼‰ï¼Œä¸ç§¯åˆ†ä½å§¿

### 4. é€Ÿåº¦æ­»åŒº
- çº¿é€Ÿåº¦ï¼š1mm/s
- è§’é€Ÿåº¦ï¼š0.001rad/s (~0.06Â°/s)
- è¿‡æ»¤ç¼–ç å™¨å™ªå£°ï¼Œé¿å…é›¶é£˜

## ğŸ“Š è°ƒè¯•æ•°æ®æ ¼å¼

`/wheel_odom_data` è¯é¢˜ (Float32MultiArray):
```
[0]  vx_robot      - æœºå™¨äººåæ ‡ç³»é€Ÿåº¦X (m/s)
[1]  vy_robot      - æœºå™¨äººåæ ‡ç³»é€Ÿåº¦Y (m/s)
[2]  wz_robot      - è§’é€Ÿåº¦ (rad/s)
[3]  dt            - æ—¶é—´å¢é‡ (s)
[4]  dx_world      - ä¸–ç•Œåæ ‡ç³»ä½ç§»å¢é‡X (m)
[5]  dy_world      - ä¸–ç•Œåæ ‡ç³»ä½ç§»å¢é‡Y (m)
[6]  pose_x        - ç´¯è®¡ä½å§¿X (m)
[7]  pose_y        - ç´¯è®¡ä½å§¿Y (m)
[8]  pose_theta    - ç´¯è®¡ä½å§¿Î¸ (rad)
[9]  roll          - IMUæ¨ªæ»šè§’ (rad)
[10] pitch         - IMUä¿¯ä»°è§’ (rad)
[11] yaw           - IMUèˆªå‘è§’ (rad)
[12] dtheta        - è§’åº¦å¢é‡ (rad)
[13] vx_world      - ä¸–ç•Œåæ ‡ç³»é€Ÿåº¦X (m/s)
[14] vy_world      - ä¸–ç•Œåæ ‡ç³»é€Ÿåº¦Y (m/s)
[15] is_stationary - é™æ­¢æ ‡å¿— (1=é™æ­¢, 0=è¿åŠ¨)
```

## ğŸš€ æµ‹è¯•å»ºè®®

### 1. é™æ­¢æµ‹è¯•ï¼ˆé›¶é£˜æ£€æµ‹ï¼‰
```bash
# ç»ˆç«¯1: å¯åŠ¨èŠ‚ç‚¹
ros2 launch navigation_control serial_debug.launch.py

# ç»ˆç«¯2: ç›‘æ§ä½å§¿
ros2 topic echo /odom --field pose.pose.position

# é¢„æœŸï¼šæœºå™¨äººé™æ­¢æ—¶ï¼Œä½å§¿åº”è¯¥ä¸å†æ¼‚ç§»
```

### 2. ç›´çº¿è¿åŠ¨æµ‹è¯•
```bash
# æ¨åŠ¨æœºå™¨äººå‰è¿›1ç±³ï¼Œè§‚å¯Ÿï¼š
# - dt åº”è¯¥ç¨³å®šåœ¨å®é™…æ§åˆ¶å‘¨æœŸï¼ˆå¦‚10-20msï¼‰
# - vx_robot åº”è¯¥ä¸å®é™…é€Ÿåº¦ä¸€è‡´
# - ç´¯è®¡ä½å§¿ x åº”è¯¥çº¦ç­‰äº1.0m
```

### 3. æ—‹è½¬æµ‹è¯•
```bash
# åŸåœ°æ—‹è½¬90åº¦ï¼Œè§‚å¯Ÿï¼š
# - wz_robot åº”è¯¥æœ‰ç¨³å®šçš„è§’é€Ÿåº¦å€¼
# - pose_theta åº”è¯¥çº¦ç­‰äº Ï€/2 rad (90Â°)
# - pose_x, pose_y åº”è¯¥æ¥è¿‘0ï¼ˆåŸåœ°æ—‹è½¬ä¸å¹³ç§»ï¼‰
```

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **é¦–å¸§è·³è¿‡**ï¼šç¬¬ä¸€ä¸ªæ•°æ®åŒ…åªç”¨äºåˆå§‹åŒ–æ—¶é—´ï¼Œä¸è¿›è¡Œç§¯åˆ†
2. **IMUæœªèåˆ**ï¼šç›®å‰åªä½¿ç”¨è½®å¼é‡Œç¨‹è®¡ï¼ŒæœªèåˆIMUæ•°æ®ï¼ˆyaw/pitch/rollä»…ç”¨äºè°ƒè¯•ï¼‰
3. **ç®€å•çŸ©å½¢ç§¯åˆ†**ï¼šæœªä½¿ç”¨æ¢¯å½¢ç§¯åˆ†æˆ–Runge-Kuttaï¼Œé«˜é€Ÿè¿åŠ¨æ—¶å¯èƒ½æœ‰å°è¯¯å·®

## ğŸ“ å‚æ•°è°ƒä¼˜æŒ‡å—

åœ¨ `wheel_odometry_node.cpp` ä¸­å¯è°ƒå‚æ•°ï¼š

```cpp
const double MIN_DT = 0.0001;           // æœ€å°æœ‰æ•ˆdt (100Î¼s)
const double MAX_DT = 0.5;              // æœ€å¤§å®‰å…¨dt (500ms)
const double VEL_THRESHOLD = 0.001;     // é€Ÿåº¦æ­»åŒº (1mm/s)
const double ANGULAR_THRESHOLD = 0.001; // è§’é€Ÿåº¦æ­»åŒº (~0.06Â°/s)
const double MOTION_THRESHOLD = 0.002;  // ç»¼åˆè¿åŠ¨é˜ˆå€¼ (2mm/s)
const double DECAY_FACTOR = 0.7;        // é™æ­¢æ—¶é€Ÿåº¦è¡°å‡ç³»æ•°
```

æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼š
- ç¼–ç å™¨å™ªå£°å¤§ â†’ æé«˜ `VEL_THRESHOLD`
- æ…¢é€Ÿè¿åŠ¨è¢«è¿‡æ»¤ â†’ é™ä½ `MOTION_THRESHOLD`
- æ§åˆ¶å‘¨æœŸä¸ç¨³å®š â†’ è°ƒæ•´ `MAX_DT`

## ğŸ‰ é¢„æœŸæ•ˆæœ

- âœ… **é›¶é£˜æ¶ˆé™¤**ï¼šé™æ­¢æ—¶ä½å§¿ä¸å†æ¼‚ç§»
- âœ… **dtå‡†ç¡®**ï¼šæ—¶é—´å¢é‡ç¬¦åˆå®é™…æ§åˆ¶å‘¨æœŸ
- âœ… **é€Ÿåº¦ä¸€è‡´**ï¼šæœºå™¨äººåæ ‡ç³»é€Ÿåº¦ä¸å®é™…è¿åŠ¨ä¸€è‡´
- âœ… **å“åº”å¿«é€Ÿ**ï¼šæ— 50mså»¶è¿Ÿï¼ˆå®æ—¶ç§¯åˆ†ï¼‰

## ğŸ” æ’æŸ¥æ¸…å•

å¦‚æœä»æœ‰é—®é¢˜ï¼š
1. æ£€æŸ¥ä¸‹ä½æœºæ˜¯å¦æ­£ç¡®å¡«å…… `chassis_vx/vy/w`ï¼ˆç”¨serial_monitor.pyæŸ¥çœ‹ï¼‰
2. ç¡®è®¤ä¸‹ä½æœºä¸ä¸Šä½æœºé€Ÿåº¦å•ä½ä¸€è‡´ï¼ˆm/s, rad/sï¼‰
3. æ£€æŸ¥æœºå™¨äººåæ ‡ç³»å®šä¹‰ï¼ˆXå‰Yå·¦ vs Xå·¦Yå‰ï¼‰
4. éªŒè¯ä¸‹ä½æœºå‘é€é¢‘ç‡ï¼ˆå»ºè®®50-100Hzï¼‰
