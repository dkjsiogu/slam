# è½®å¼é‡Œç¨‹è®¡é›†æˆæ–¹æ¡ˆæ€»ç»“

## ğŸ¯ æ ¸å¿ƒæ€è·¯

**é—®é¢˜**: ç´¯è®¡ä½ç½®(x,y)å’Œç´¯è®¡è§’åº¦(theta)åœ¨ä¸åŒåæ ‡ç³»ä¼šå†²çª

**è§£å†³æ–¹æ¡ˆ**: **ä¸‹ä½æœºå‘å¢é‡ + ä¸Šä½æœºç§¯åˆ†åˆ°ä¸–ç•Œåæ ‡ç³»** â­

---

## ğŸ“Š æ•°æ®æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        STM32ä¸‹ä½æœº                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¼–ç å™¨ â†’ è½®é€Ÿ â†’ æœºå™¨äººé€Ÿåº¦(vx, vy, wz)                         â”‚
â”‚                     â†“                                           â”‚
â”‚          é€Ÿåº¦ Ã— dt = å¢é‡(delta_x, delta_y, delta_theta)        â”‚
â”‚                     â†“                                           â”‚
â”‚          ç»„è£…23å­—èŠ‚æ•°æ®åŒ… (æœºå™¨äººåæ ‡ç³»å¢é‡)                     â”‚
â”‚                     â†“                                           â”‚
â”‚                UARTå‘é€ (50Hz)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ ä¸²å£é€šä¿¡
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ROS2ä¸Šä½æœº                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  serial_communication â†’ serial_rx_data                          â”‚
â”‚                     â†“                                           â”‚
â”‚  wheel_odometry_node æ¥æ”¶                                       â”‚
â”‚                     â†“                                           â”‚
â”‚  åæ ‡å˜æ¢: æœºå™¨äººåæ ‡ç³» â†’ ä¸–ç•Œåæ ‡ç³» (æ—‹è½¬çŸ©é˜µ)                  â”‚
â”‚    delta_x_world = delta_x*cos(Î¸) - delta_y*sin(Î¸)             â”‚
â”‚    delta_y_world = delta_x*sin(Î¸) + delta_y*cos(Î¸)             â”‚
â”‚                     â†“                                           â”‚
â”‚  ç´¯è®¡åˆ°ä¸–ç•Œåæ ‡ç³»: x += delta_x_world, y += delta_y_world       â”‚
â”‚                     â†“                                           â”‚
â”‚  å‘å¸ƒ /odom (nav_msgs/Odometry)                                 â”‚
â”‚  å‘å¸ƒ TF: odom â†’ base_link                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
            Cartographer / AMCL / Nav2
```

---

## ğŸ“¦ åè®®æ ¼å¼ (23å­—èŠ‚)

```
Offset | Size | Type     | Field        | Unit  | Description
-------|------|----------|--------------|-------|---------------------------
0      | 1    | uint8_t  | header       | -     | å›ºå®š0xA5
1      | 4    | float    | delta_x      | m     | å‰è¿›è·ç¦»å¢é‡(æœºå™¨äººåæ ‡ç³»)
5      | 4    | float    | delta_y      | m     | ä¾§å‘è·ç¦»å¢é‡(æœºå™¨äººåæ ‡ç³»)
9      | 4    | float    | delta_theta  | rad   | è§’åº¦å¢é‡
13     | 4    | float    | vx           | m/s   | Xé€Ÿåº¦(æœºå™¨äººåæ ‡ç³»)
17     | 4    | float    | vy           | m/s   | Yé€Ÿåº¦(æœºå™¨äººåæ ‡ç³»)
21     | 4    | float    | wz           | rad/s | è§’é€Ÿåº¦
25     | 4    | uint32_t | timestamp    | ms    | æ—¶é—´æˆ³
29     | 2    | uint16_t | crc16        | -     | CRC16æ ¡éªŒ
31     | 1    | uint8_t  | tail         | -     | å›ºå®š0x0D
```

---

## âœ… å·²å®ç°çš„æ–‡ä»¶

### ROS2ç«¯ (ä¸Šä½æœº)

1. **`src/navigation_control/src/wheel_odometry_node.cpp`**
   - æ¥æ”¶ä¸‹ä½æœºå¢é‡æ•°æ®
   - åæ ‡ç³»è½¬æ¢ (æœºå™¨äººâ†’ä¸–ç•Œ)
   - å‘å¸ƒ `/odom` è¯é¢˜
   - å‘å¸ƒ TF: `odom â†’ base_link`

2. **`src/navigation_control/CMakeLists.txt`** (å·²æ›´æ–°)
   - æ·»åŠ ç¼–è¯‘ `wheel_odometry_node`

3. **`src/navigation_control/launch/mapping.launch.py`** (å·²æ›´æ–°)
   - ç§»é™¤é™æ€TF: `odom â†’ base_link`
   - æ·»åŠ  `wheel_odometry_node` å¯åŠ¨

### æ–‡æ¡£

4. **`docs/STM32_ODOMETRY_REFERENCE.md`**
   - STM32å®Œæ•´å®ç°å‚è€ƒä»£ç 
   - ä¸‰è½®å…¨å‘è½®è¿åŠ¨å­¦å…¬å¼
   - CubeMXé…ç½®è¯´æ˜
   - è°ƒè¯•ä¸æ•…éšœæ’æŸ¥

---

## ğŸ”§ ä¸‹ä½æœºéœ€è¦å®ç° (STM32)

### æ ¸å¿ƒä»£ç æ¡†æ¶

```c
// 50Hzå®šæ—¶å™¨ä¸­æ–­ (æ¯20msæ‰§è¡Œä¸€æ¬¡)
void TIM_OdometryCallback(void) {
    // 1. è¯»å–ç¼–ç å™¨å¢é‡
    int16_t delta_enc1 = GetEncoderDelta(WHEEL1);
    int16_t delta_enc2 = GetEncoderDelta(WHEEL2);
    int16_t delta_enc3 = GetEncoderDelta(WHEEL3);
    
    // 2. ç¼–ç å™¨ â†’ è½®é€Ÿ
    float v1 = EncoderToVelocity(delta_enc1);
    float v2 = EncoderToVelocity(delta_enc2);
    float v3 = EncoderToVelocity(delta_enc3);
    
    // 3. ä¸‰è½®å…¨å‘è½®é€†è¿åŠ¨å­¦ (è½®é€Ÿ â†’ æœºå™¨äººé€Ÿåº¦)
    float vx = (2*v1 - v2 - v3) / 3.0f;
    float vy = (v2 - v3) * 0.577f;  // sqrt(3)/3
    float wz = (v1 + v2 + v3) / (3.0f * WHEEL_BASE);
    
    // 4. è®¡ç®—å¢é‡
    float dt = 0.02f;  // 20ms
    float delta_x = vx * dt;
    float delta_y = vy * dt;
    float delta_theta = wz * dt;
    
    // 5. ç»„è£…æ•°æ®åŒ…å¹¶å‘é€
    OdometryDeltaPacket packet;
    packet.header = 0xA5;
    packet.delta_x = delta_x;
    packet.delta_y = delta_y;
    packet.delta_theta = delta_theta;
    packet.vx = vx;
    packet.vy = vy;
    packet.wz = wz;
    packet.timestamp = HAL_GetTick();
    packet.crc16 = CalculateCRC16(&packet);
    packet.tail = 0x0D;
    
    HAL_UART_Transmit(&huart1, (uint8_t*)&packet, 23, 10);
}
```

### éœ€è¦é…ç½®çš„å‚æ•°

```c
// åœ¨STM32ä»£ç ä¸­å®šä¹‰ (æ ¹æ®å®é™…ç¡¬ä»¶ä¿®æ”¹)
#define WHEEL_RADIUS        0.050f   // è½®å­åŠå¾„ (m)
#define WHEEL_BASE          0.200f   // è½®è· (m)
#define ENCODER_PPR         1024     // ç¼–ç å™¨åˆ†è¾¨ç‡
#define GEAR_RATIO          20.0f    // å‡é€Ÿæ¯”
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### ç¼–è¯‘

```bash
cd ~/slam
colcon build --packages-select navigation_control
source install/setup.bash
```

### å¯åŠ¨ (å»ºå›¾æ¨¡å¼)

```bash
# å¯åŠ¨å»ºå›¾ç³»ç»Ÿ (åŒ…å«é‡Œç¨‹è®¡èŠ‚ç‚¹)
ros2 launch navigation_control mapping.launch.py
```

### æµ‹è¯•é‡Œç¨‹è®¡

```bash
# ç»ˆç«¯1: æŸ¥çœ‹é‡Œç¨‹è®¡è¯é¢˜
ros2 topic echo /odom

# ç»ˆç«¯2: æŸ¥çœ‹TFæ ‘
ros2 run tf2_tools view_frames

# ç»ˆç«¯3: ç›‘æ§ä¸²å£æ¥æ”¶
ros2 topic echo /serial_rx_hex

# ç»ˆç«¯4: é‡ç½®é‡Œç¨‹è®¡ (å¦‚æœéœ€è¦)
ros2 service call /reset_odometry std_srvs/srv/Empty
```

### éªŒè¯æ•°æ®

```bash
# æ£€æŸ¥é‡Œç¨‹è®¡æ•°æ®åŒ…ç»Ÿè®¡
ros2 topic echo /wheel_odometry_node/statistics

# æœŸæœ›çœ‹åˆ°:
# - æ”¶åŒ…: æŒç»­å¢é•¿
# - æ— æ•ˆ/CRCé”™è¯¯: åº”è¯¥ä¸º0
```

---

## ğŸ“ å…³é”®ä¼˜åŠ¿

### âœ… ä¼˜ç‚¹

1. **ä¸‹ä½æœºç®€å•**: åªç®—å¢é‡ï¼Œä¸ç´¯è®¡ï¼Œä¸ç”¨ç®¡åæ ‡ç³»è½¬æ¢
2. **ç²¾åº¦é«˜**: é«˜é¢‘é‡‡æ ·(50Hz)ï¼Œæ•°å€¼ç¨³å®š
3. **å®¹æ˜“è°ƒè¯•**: å¢é‡æ•°æ®ç›´è§‚ï¼Œé—®é¢˜å¥½å®šä½
4. **æ”¯æŒé‡å®šä½**: ä¸Šä½æœºå¯ä»¥éšæ—¶é‡ç½®ç´¯è®¡å€¼
5. **ç¬¦åˆROSæ ‡å‡†**: å®Œå…¨å…¼å®¹Nav2å’ŒCartographer

### ğŸ”‘ å…³é”®ç‚¹

- **ä¸‹ä½æœº**: å§‹ç»ˆåœ¨**æœºå™¨äººåæ ‡ç³»**è®¡ç®—
- **ä¸Šä½æœº**: è´Ÿè´£è½¬æ¢åˆ°**ä¸–ç•Œåæ ‡ç³»**(odom frame)
- **TFæ ‘**: `map â†’ odom(SLAM) â†’ base_link(é‡Œç¨‹è®¡) â†’ laser(é™æ€)`

---

## ğŸ“ TODOæ¸…å•

### ä¸‹ä½æœºå›¢é˜Ÿ

- [ ] ç¡®è®¤ç¼–ç å™¨å‚æ•° (PPR, å‡é€Ÿæ¯”, è½®å­åŠå¾„)
- [ ] å®ç°50Hzå®šæ—¶å™¨å‘é€é‡Œç¨‹è®¡æ•°æ®
- [ ] éªŒè¯ä¸‰è½®è¿åŠ¨å­¦è®¡ç®—æ­£ç¡®æ€§
- [ ] æµ‹è¯•CRC16æ ¡éªŒåŠŸèƒ½
- [ ] æä¾›å®é™…ç¡¬ä»¶å‚æ•°ç»™ä¸Šä½æœº

### ä¸Šä½æœºå›¢é˜Ÿ (å·²å®Œæˆ)

- [x] å®ç° `wheel_odometry_node.cpp`
- [x] æ›´æ–° `CMakeLists.txt`
- [x] æ›´æ–° `mapping.launch.py`
- [x] ç¼–å†™STM32å‚è€ƒæ–‡æ¡£
- [ ] å®é™…æµ‹è¯•å¹¶è°ƒå‚ (ç­‰ä¸‹ä½æœºæ•°æ®)
- [ ] æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´åæ–¹å·®çŸ©é˜µ

---

## ğŸ“ è”ç³»ä¸åä½œ

**æ•°æ®æ¥å£**: `serial_rx_data` (std_msgs/UInt8MultiArray)

**å¦‚æœéœ€è¦ä¿®æ”¹åè®®**ï¼Œè¯·åŒæ­¥æ›´æ–°:
1. STM32ç«¯æ•°æ®ç»“æ„
2. ROS2ç«¯ `OdometryDeltaPacket` ç»“æ„
3. æœ¬æ–‡æ¡£ä¸­çš„åè®®è¯´æ˜

**é‡åˆ°é—®é¢˜è¯·æ£€æŸ¥**:
1. ä¸²å£æ³¢ç‰¹ç‡æ˜¯å¦ä¸€è‡´ (é»˜è®¤115200)
2. CRC16è¡¨æ˜¯å¦å®Œå…¨ç›¸åŒ
3. æ•°æ®åŒ…é•¿åº¦æ˜¯å¦ä¸º23å­—èŠ‚
4. å¸§å¤´0xA5å’Œå¸§å°¾0x0Dæ˜¯å¦æ­£ç¡®

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-06  
**ä½œè€…**: SLAMå›¢é˜Ÿ ğŸ¤–
