# Navigation Control - å…¨å‘è½®æœºå™¨äººå¯¼èˆªç³»ç»Ÿ

åŸºäº ROS2 Humble + Cartographer + è‡ªå®šä¹‰ A* è·¯å¾„è§„åˆ’çš„å®Œæ•´å¯¼èˆªè§£å†³æ–¹æ¡ˆã€‚

[![ROS2](https://img.shields.io/badge/ROS2-Humble-blue)](https://docs.ros.org/en/humble/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

## ï¿½ æ¨¡å—ç»„æˆ

```
navigation_control/
â”œâ”€â”€ launch/                     # å¯åŠ¨æ–‡ä»¶
â”‚   â”œâ”€â”€ cartographer_localization.launch.py  # å®šä½+å¯¼èˆª
â”‚   â””â”€â”€ mapping.launch.py                    # å»ºå›¾æ¨¡å¼
â”œâ”€â”€ config/                     # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ cartographer_localization.lua        # Cartographerçº¯å®šä½é…ç½®
â”‚   â”œâ”€â”€ cartographer_mapping.lua             # Cartographerå»ºå›¾é…ç½®
â”‚   â””â”€â”€ navigation_debug.rviz                # RVizå¯è§†åŒ–é…ç½®
â”œâ”€â”€ scripts/                    # PythonèŠ‚ç‚¹
â”‚   â”œâ”€â”€ astar_planner.py                     # A*è·¯å¾„è§„åˆ’
â”‚   â”œâ”€â”€ simple_goal_controller.py            # Pure Pursuitæ§åˆ¶
â”‚   â””â”€â”€ map_republisher.py                   # åœ°å›¾è¯é¢˜è½¬å‘
â”œâ”€â”€ src/                        # C++èŠ‚ç‚¹
â”‚   â”œâ”€â”€ wheel_odometry_node.cpp              # è½®å¼é‡Œç¨‹è®¡
â”‚   â”œâ”€â”€ serial_communication.cpp             # ä¸²å£æ¥æ”¶
â”‚   â”œâ”€â”€ serial_data_publisher.cpp            # ä¸²å£å‘é€
â”‚   â””â”€â”€ scan_filter_node.cpp                 # æ¿€å…‰è¿‡æ»¤
â”œâ”€â”€ urdf/                       # æœºå™¨äººæ¨¡å‹
â”‚   â””â”€â”€ robot.urdf                           # TFé™æ€å‘å¸ƒ
â””â”€â”€ maps/                       # åœ°å›¾æ–‡ä»¶
    â””â”€â”€ my_map.pbstream                      # Cartographeråœ°å›¾
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1ï¸âƒ£ å»ºå›¾æ¨¡å¼ (Mapping)
```bash
ros2 launch navigation_control mapping.launch.py
```
- **åŠŸèƒ½**ï¼šä½¿ç”¨ Cartographer å»ºç«‹ 2D å ç”¨æ …æ ¼åœ°å›¾
- **æ•°æ®æº**ï¼šRPLIDAR A1 (8Hz) + è½®å¼é‡Œç¨‹è®¡ + IMU
- **è¾“å‡º**ï¼šä¿å­˜ä¸º `.pbstream` åœ°å›¾æ–‡ä»¶

### 2ï¸âƒ£ å®šä½ä¸å¯¼èˆªæ¨¡å¼ (Localization + Navigation)
```bash
ros2 launch navigation_control cartographer_localization.launch.py \
  pbstream_file:=/path/to/my_map.pbstream
```
- **å®šä½**ï¼šCartographer çº¯å®šä½æ¨¡å¼ï¼ˆåŠ è½½å·²æœ‰åœ°å›¾ï¼‰
- **è·¯å¾„è§„åˆ’**ï¼šè‡ªå®šä¹‰ A* ç®—æ³• + çŸ©å½¢æœºå™¨äººè¶³è¿¹ç¢°æ’æ£€æµ‹
- **è·¯å¾„ä¼˜åŒ–**ï¼šæ’å€¼ â†’ å¹³æ»‘ï¼ˆ20æ¬¡è¿­ä»£ï¼‰â†’ æ›²ç‡ç®€åŒ–
- **è·Ÿè¸ªæ§åˆ¶**ï¼šPure Pursuit + å…¨å‘è½®è¿åŠ¨å­¦

## ğŸ› ï¸ ç³»ç»Ÿæ¶æ„

### èŠ‚ç‚¹æ‹“æ‰‘
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Cartographer                          â”‚
â”‚  (çº¯å®šä½ + å‘å¸ƒ mapâ†’odom TF)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ /map
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   astar_planner.py                        â”‚
â”‚  (çŸ©å½¢footprintç¢°æ’æ£€æµ‹ + åœ†å¼§è·¯å¾„ç”Ÿæˆ)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ /planned_path
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              simple_goal_controller.py                    â”‚
â”‚  (Pure Pursuitè·Ÿè¸ª + ä¿æŒåˆå§‹æœå‘)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ /cmd_vel
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              serial_data_publisher                        â”‚
â”‚  (é€Ÿåº¦å‘½ä»¤ â†’ ä¸‹ä½æœºåè®®è½¬æ¢)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### TF æ ‘
```
map â†’ odom (Cartographer)
      â†“
    base_link (wheel_odometry_node)
      â†“
    laser (URDFé™æ€å‘å¸ƒ)
```

### æ ¸å¿ƒèŠ‚ç‚¹

| èŠ‚ç‚¹ | è¯­è¨€ | åŠŸèƒ½ |
|------|------|------|
| `wheel_odometry_node` | C++ | è½®å¼é‡Œç¨‹è®¡ï¼šè§£æä¸‹ä½æœºæ•°æ® â†’ å‘å¸ƒ `/odom` + TF |
| `serial_communication` | C++ | ä¸²å£é€šä¿¡ï¼šæ¥æ”¶ä¸‹ä½æœºä¼ æ„Ÿå™¨æ•°æ® |
| `serial_data_publisher` | C++ | é€Ÿåº¦å‘½ä»¤è½¬åè®®ï¼š`/cmd_vel` â†’ ä¸‹ä½æœºæ ¼å¼ |
| `scan_filter_node` | C++ | æ¿€å…‰è¿‡æ»¤ï¼šè¿‡æ»¤æœºå™¨äººæœ¬ä½“åå°„ç‚¹ |
| `astar_planner.py` | Python | A* è·¯å¾„è§„åˆ’ + çŸ©å½¢è¶³è¿¹ç¢°æ’ + å¹³æ»‘ç®€åŒ– |
| `simple_goal_controller.py` | Python | Pure Pursuit è·¯å¾„è·Ÿè¸ª |
| `map_republisher.py` | Python | åœ°å›¾è¯é¢˜è½¬å‘ï¼ˆè§£å†³RViz QoSé—®é¢˜ï¼‰|

## ğŸ”§ ç¡¬ä»¶è¦æ±‚

- **æœºå™¨äºº**ï¼šå…¨å‘è½®åº•ç›˜ï¼ˆ262mm Ã— 270mmï¼‰
- **æ¿€å…‰é›·è¾¾**ï¼šSLAMTEC RPLIDAR A1 (8Hz, ä¸²å£)
- **ä¼ æ„Ÿå™¨**ï¼š3è½´IMUï¼ˆé™€èºä»ª + åŠ é€Ÿåº¦è®¡ï¼‰
- **ä¸‹ä½æœº**ï¼šSTM32ï¼ˆä¸²å£115200ï¼Œè‡ªå®šä¹‰åè®®ï¼‰
- **è®¾å¤‡æ˜ å°„**ï¼š
  - `/dev/radar` â†’ RPLIDAR
  - `/dev/stm32` â†’ ä¸‹ä½æœº

## ğŸ“¦ å®‰è£…æŒ‡å—

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**ï¼šUbuntu 22.04
- **ROS2 ç‰ˆæœ¬**ï¼šHumble Hawksbill

### 1. å®‰è£…ä¾èµ–

#### ROS2 è½¯ä»¶åŒ…
```bash
sudo apt install ros-humble-cartographer-ros \
                 ros-humble-robot-state-publisher \
                 ros-humble-rviz2 \
                 libserial-dev
```

#### RPLIDAR é©±åŠ¨
```bash
# å…‹éš†å®˜æ–¹é©±åŠ¨åˆ°å·¥ä½œåŒº
cd ~/ros2_ws/src  # æˆ–ä½ çš„å·¥ä½œåŒº
git clone https://github.com/Slamtec/sllidar_ros2.git
```

### 2. å…‹éš†æœ¬é¡¹ç›®
```bash
cd ~/ros2_ws/src
git clone <your-repo-url> navigation_control
```

### 3. ç¼–è¯‘
```bash
cd ~/ros2_ws
source /opt/ros/humble/setup.bash
colcon build --symlink-install --packages-select navigation_control sllidar_ros2
source install/setup.bash
```

### 4. é…ç½®ä¸²å£æƒé™
```bash
# æ·»åŠ ç”¨æˆ·åˆ° dialout ç»„
sudo usermod -aG dialout $USER

# åˆ›å»º udev è§„åˆ™ï¼ˆå¯é€‰ï¼Œç”¨äºå›ºå®šè®¾å¤‡åï¼‰
sudo nano /etc/udev/rules.d/99-robot.rules
# æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š
# KERNEL=="ttyUSB*", ATTRS{idVendor}=="10c4", ATTRS{idProduct}=="ea60", SYMLINK+="radar"
# KERNEL=="ttyUSB*", ATTRS{idVendor}=="0483", ATTRS{idProduct}=="5740", SYMLINK+="stm32"

# é‡æ–°åŠ è½½è§„åˆ™
sudo udevadm control --reload-rules && sudo udevadm trigger

# é‡å¯ç”Ÿæ•ˆ
```

## ğŸ® ä½¿ç”¨æµç¨‹

### ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼ˆå»ºå›¾ï¼‰
1. **å¯åŠ¨å»ºå›¾**
   ```bash
   ros2 launch navigation_control mapping.launch.py
   ```

2. **é¥æ§å»ºå›¾**
   - ä½¿ç”¨é¥æ§å™¨/é”®ç›˜æ§åˆ¶æœºå™¨äººç§»åŠ¨
   - è¦†ç›–æ‰€æœ‰åŒºåŸŸ

3. **ä¿å­˜åœ°å›¾**
   ```bash
   ros2 service call /write_state cartographer_ros_msgs/srv/WriteState \
     "{filename: '${PWD}/src/navigation_control/maps/my_map.pbstream'}"
   ```

### æ—¥å¸¸ä½¿ç”¨ï¼ˆå¯¼èˆªï¼‰
1. **å¯åŠ¨å®šä½å¯¼èˆª**
   ```bash
   ros2 launch navigation_control cartographer_localization.launch.py
   ```

2. **åœ¨ RViz2 ä¸­è®¾ç½®ç›®æ ‡ç‚¹**
   - ç‚¹å‡»å·¥å…·æ  "2D Goal Pose"
   - åœ¨åœ°å›¾ä¸Šç‚¹å‡»ç›®æ ‡ä½ç½®
   - æœºå™¨äººè‡ªåŠ¨è§„åˆ’è·¯å¾„å¹¶æ‰§è¡Œ

3. **è·¯å¾„å¯è§†åŒ–**
   - é»„è‰²è·¯å¾„ï¼š`/raw_planned_path`ï¼ˆåŸå§‹A*è¾“å‡ºï¼‰
   - ç»¿è‰²è·¯å¾„ï¼š`/planned_path`ï¼ˆä¼˜åŒ–åçš„å¹³æ»‘è·¯å¾„ï¼‰

## âš™ï¸ å…³é”®å‚æ•°è°ƒä¼˜

### è·¯å¾„è§„åˆ’å‚æ•° (`cartographer_localization.launch.py`)
```python
'robot_length': 0.262,          # æœºå™¨äººé•¿åº¦ (m)
'robot_width': 0.270,           # æœºå™¨äººå®½åº¦ (m)
'safety_margin': 0.03,          # å®‰å…¨è£•é‡ (m)
'diagonal_penalty': 1.2,        # å¯¹è§’çº¿æƒ©ç½šç³»æ•°
'smoothing_iterations': 20,     # å¹³æ»‘è¿­ä»£æ¬¡æ•°ï¼ˆè¶Šå¤§è¶Šåœ†æ¶¦ï¼‰
'waypoint_spacing': 0.20,       # è·¯å¾„ç‚¹æœ€å°é—´è· (m)
```

### é€Ÿåº¦é™åˆ¶å‚æ•°
```python
'max_linear_vel': 0.5,          # æœ€å¤§çº¿é€Ÿåº¦ (m/s)
'max_angular_vel': 0.3,         # æœ€å¤§è§’é€Ÿåº¦ (rad/s)
'goal_tolerance': 0.10,         # ç›®æ ‡å®¹å·® (m)
'lookahead_distance': 0.5,      # Pure Pursuitå‰ç»è·ç¦» (m)
```

## ğŸ› å¸¸è§é—®é¢˜

### 1. IMU Yaw æ¼‚ç§»
**ç°è±¡**ï¼šæœºå™¨äººé™æ­¢æ—¶è§’åº¦ç¼“æ…¢å˜åŒ–  
**åŸå› **ï¼šé™€èºä»ªé›¶æ¼‚ç§¯ç´¯  
**è§£å†³**ï¼šå·²åœ¨ `wheel_odometry_node.cpp` ä¸­å®ç°é™æ­¢æ£€æµ‹ï¼Œè‡ªåŠ¨å†»ç»“IMUæ›´æ–°

### 2. RViz2 æ¶ˆæ¯ä¸¢å¼ƒè­¦å‘Š
**ç°è±¡**ï¼šç»ˆç«¯è¾“å‡º "Message Filter dropping message"  
**åŸå› **ï¼šTFé˜Ÿåˆ—æº¢å‡º  
**è§£å†³**ï¼šå·²ä¼˜åŒ– `navigation_debug.rviz` é…ç½®ï¼ˆDepth=1, Best Effortï¼‰

### 3. è·¯å¾„åˆ‡è§’
**ç°è±¡**ï¼šè½¬å¼¯æ—¶è·¯å¾„è¿‡äºç¬”ç›´  
**è°ƒä¼˜**ï¼šå¢åŠ  `smoothing_iterations` å‚æ•°ï¼ˆå½“å‰20æ¬¡ï¼‰

### 4. å®šä½å¤±è´¥
**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥ `.pbstream` åœ°å›¾æ–‡ä»¶è·¯å¾„
2. ç¡®ä¿æœºå™¨äººåœ¨åœ°å›¾èŒƒå›´å†…å¯åŠ¨
3. Cartographer ä¼šè‡ªåŠ¨å…¨å±€å®šä½ï¼ˆæ— éœ€æ‰‹åŠ¨è®¾ç½®åˆå§‹ä½å§¿ï¼‰

## ğŸ“ å¼€å‘æŒ‡å—

- **ä»£ç é£æ ¼**ï¼šå‚è€ƒ `.github/copilot-instructions.md`
- **è°ƒè¯•å·¥å…·**ï¼šRViz2 å®æ—¶å¯è§†åŒ–æ‰€æœ‰è¯é¢˜
- **æ—¥å¿—ä½ç½®**ï¼š`log/latest_build/`

## ğŸ¯ ç³»ç»Ÿç‰¹æ€§

âœ… **æ— éœ€ Nav2**ï¼šå®Œå…¨è‡ªå®šä¹‰å¯¼èˆªæ ˆï¼Œè½»é‡é«˜æ•ˆ  
âœ… **çŸ©å½¢ç¢°æ’æ£€æµ‹**ï¼šç²¾ç¡®çš„æœºå™¨äººè¶³è¿¹å»ºæ¨¡  
âœ… **åœ†å¼§è·¯å¾„ç”Ÿæˆ**ï¼šå¹³æ»‘è¿‡æ¸¡ï¼Œé¿å…æ€¥è½¬å¼¯  
âœ… **IMU èåˆ**ï¼šå¢å¼ºè§’åº¦ä¼°è®¡ç²¾åº¦  
âœ… **è‡ªåŠ¨å…¨å±€å®šä½**ï¼šCartographer æ— éœ€åˆå§‹ä½å§¿  
âœ… **å®æ—¶éšœç¢ç‰©è¿‡æ»¤**ï¼šè¿‡æ»¤æœºå™¨äººæœ¬ä½“åå°„

## ğŸ“„ è®¸å¯è¯

- `sllidar_ros2`: BSD-2-Clause (Slamtecå®˜æ–¹)
- `navigation_control`: MIT
- `my_slam_config`: MIT

---

**æœ€åæ›´æ–°**ï¼š2025å¹´11æœˆ12æ—¥  
**ROS2 ç‰ˆæœ¬**ï¼šHumble Hawksbill  
**æœºå™¨äººå¹³å°**ï¼šå…¨å‘è½®åº•ç›˜ + RPLIDAR A1
